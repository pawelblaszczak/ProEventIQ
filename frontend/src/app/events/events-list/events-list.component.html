<div class="events-container">
  <div class="header-section">
    <div class="header-content">
      <h1 class="page-title">{{ 'EVENTS.LIST.TITLE' | translate }}</h1>
      <p class="page-subtitle">{{ 'EVENTS.LIST.SUBTITLE' | translate }}</p>
    </div>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="addEvent()" class="edit-button" [attr.aria-label]="'EVENTS.LIST.ADD_BUTTON' | translate">
        <mat-icon>add</mat-icon>
        {{ 'EVENTS.LIST.ADD_BUTTON' | translate }}
      </button>
    </div>
  </div>

  <mat-card class="filter-card">
    <mat-card-content>
      <div class="filter-container">
        <div class="filter-row" style="display: flex; gap: 16px;">
          <mat-form-field appearance="outline" class="search-field" style="flex: 1; min-width: 0;">
            <mat-label>{{ 'EVENTS.LIST.SEARCH_LABEL' | translate }}</mat-label>
            <input matInput (input)="applyFilter($event)" [placeholder]="'EVENTS.LIST.SEARCH_PLACEHOLDER' | translate">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
          <div style="display: flex; flex: 1; min-width: 0; gap: 16px;">
            <mat-form-field appearance="outline" class="filter-field" style="flex: 1; min-width: 0;">
              <mat-label>{{ 'EVENTS.LIST.FILTER_DATE_FROM' | translate }}</mat-label>
              <input matInput type="date" [placeholder]="'EVENTS.LIST.FILTER_DATE_FROM_PLACEHOLDER' | translate" (input)="filterByDateFrom($event)" [value]="today">
              <mat-icon matSuffix>event</mat-icon>
            </mat-form-field>
            <mat-form-field appearance="outline" class="filter-field" style="flex: 1; min-width: 0;">
              <mat-label>{{ 'EVENTS.LIST.FILTER_DATE_TO' | translate }}</mat-label>
              <input matInput type="date" [placeholder]="'EVENTS.LIST.FILTER_DATE_TO_PLACEHOLDER' | translate" (input)="filterByDateTo($event)">
              <mat-icon matSuffix>event</mat-icon>
            </mat-form-field>
          </div>
        </div>
        <div class="advanced-filters" style="display: flex; gap: 16px;">
          <mat-form-field appearance="outline" class="filter-field" style="flex: 1; min-width: 0;">
            <mat-label>{{ 'EVENTS.LIST.FILTER_SHOW' | translate }}</mat-label>
            <input type="text" matInput [matAutocomplete]="autoShow" (input)="filterShowInput($event)" [value]="showInputValue" [placeholder]="'EVENTS.LIST.FILTER_SHOW_PLACEHOLDER' | translate">
            <mat-autocomplete #autoShow="matAutocomplete" (optionSelected)="filterByShow($event)">
              <mat-option value="">{{ 'EVENTS.LIST.FILTER_SHOW_ALL' | translate }}</mat-option>
              @for (show of filteredShows() | orderByName; track show.showId) {
                <mat-option [value]="show.showId">{{ show.name }}</mat-option>
              }
            </mat-autocomplete>
            <mat-icon matSuffix>theaters</mat-icon>
          </mat-form-field>
          <mat-form-field appearance="outline" class="filter-field" style="flex: 1; min-width: 0;">
            <mat-label>{{ 'EVENTS.LIST.FILTER_VENUE' | translate }}</mat-label>
            <input type="text" matInput [matAutocomplete]="autoVenue" (input)="filterVenueInput($event)" [value]="venueInputValue" [placeholder]="'EVENTS.LIST.FILTER_VENUE_PLACEHOLDER' | translate">
            <mat-autocomplete #autoVenue="matAutocomplete" (optionSelected)="filterByVenue($event)">
              <mat-option value="">{{ 'EVENTS.LIST.FILTER_VENUE_ALL' | translate }}</mat-option>
              @for (venue of filteredVenues() | orderByName; track venue.venueId) {
                <mat-option [value]="venue.venueId">{{ venue.name }}</mat-option>
              }
            </mat-autocomplete>
            <mat-icon matSuffix>location_on</mat-icon>
          </mat-form-field>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  @if (isLoading()) {
    <div class="loading-spinner">
      <mat-spinner diameter="48"></mat-spinner>
      <p class="loading-text">{{ 'EVENTS.LIST.LOADING' | translate }}</p>
    </div>
  } @else if (error()) {
    <div class="error-section">
      <app-error-display 
        [error]="error()!" 
        [title]="'EVENTS.LIST.ERROR_TITLE' | translate" 
        icon="event_note"
        cssClass="events-error">
      </app-error-display>
      <div class="error-actions">
        <button mat-raised-button color="primary" (click)="retry()">
          <mat-icon>refresh</mat-icon>
          {{ 'EVENTS.LIST.RETRY' | translate }}
        </button>
        <button mat-stroked-button (click)="resetFilters()">
          <mat-icon>filter_list_off</mat-icon>
          {{ 'EVENTS.LIST.RESET_FILTERS' | translate }}
        </button>
      </div>
    </div>
  } @else if (filteredEvents().length === 0) {
    <mat-card class="empty-state">
      <mat-card-content>
        <mat-icon class="empty-icon">event_note</mat-icon>
        <h2>{{ 'EVENTS.LIST.EMPTY_TITLE' | translate }}</h2>
        <p>{{ 'EVENTS.LIST.EMPTY_DESC' | translate }}</p>
        <button mat-stroked-button color="primary" (click)="resetFilters()">{{ 'EVENTS.LIST.RESET_FILTERS' | translate }}</button>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="events-list">
      @for (event of filteredEvents(); track event.eventId) {
        <mat-card class="event-item" [routerLink]="['/events', event.eventId]">
          <!-- Use CSS grid with fixed column widths to keep the error column aligned across all rows: date | details | error | seat | actions -->
          <!-- Increase seat-status column to give more room for the badge/text -->
          <mat-card-content class="event-content" style="display:grid; grid-template-columns: 72px 1fr 36px minmax(200px, 280px) 48px; align-items:center; gap:16px;">
            <div class="event-date-section">
              <div class="date-block">
                <div class="date-day">{{ formatDateOnly(event.dateTime) }}</div>
                <div class="date-year">{{ formatYear(event.dateTime) }}</div>
              </div>
            </div>
            
            <div class="event-details" style="min-width:0;">
              <div class="event-header">
                <h3 class="event-title">{{ event.showName || ('EVENTS.LIST.UNTITLED_SHOW' | translate) }}</h3>
              </div>
              
              <div class="event-meta">
                <div class="meta-item">
                  <mat-icon>schedule</mat-icon>
                  <span>{{ formatTime(event.dateTime) }}</span>
                </div>
                <div class="meta-item">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ event.venueName || ('EVENTS.LIST.TBD' | translate) }}</span>
                </div>
                <div class="meta-item">
                  <mat-icon>public</mat-icon>
                  <span>{{ event.country || ('EVENTS.LIST.UNKNOWN_COUNTRY' | translate) }}</span>
                </div>
                <div class="meta-item">
                  <mat-icon>location_city</mat-icon>
                  <span>{{ event.city || ('EVENTS.LIST.UNKNOWN_CITY' | translate) }}</span>
                </div>
              </div>
            </div>
            
            <!-- Fixed-width error column so the warning icon stays in the same horizontal position for every row -->
            <div class="error-column" style="width:36px; display:flex; align-items:center; justify-content:center;">
              <mat-icon *ngIf="event.hasAllocationErrors" color="warn" style="font-size:20px; line-height:20px; transform: translateY(2px);" [matTooltip]="'EVENTS.LIST.ALLOCATION_ERRORS' | translate">warning</mat-icon>
            </div>

            <div class="seat-status">
              <div class="seat-indicator" [ngClass]="getReservationClass(event)" style="background: #f3f3f3; border-radius: 999px; padding: 4px 12px; display: inline-flex; align-items: center; gap: 8px; min-height: 32px;">
                <mat-icon [style.color]="getSeatStatusColor(event)">event_seat</mat-icon>
                <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                  <span class="seat-text" [style.color]="getSeatStatusColor(event)" style="line-height: 1.2;">{{ getSeatStatusText(event) }}</span>
                  @if (event.blockedSeats && event.blockedSeats > 0) {
                    <span class="blocked-text" [style.color]="getSeatStatusColor(event)" style="font-size: 0.75rem; line-height: 1.1;">{{ event.blockedSeats }} {{ 'EVENTS.LIST.BLOCKED' | translate }}</span>
                  }
                </div>
              </div>
            </div>
            
            <div class="event-actions">
              <button mat-icon-button color="primary" class="action-button" aria-label="View event details">
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      }
      <mat-paginator
        [length]="totalItems()"
        [pageIndex]="page() - 1"
        [pageSize]="pageSize()"
        [pageSizeOptions]="[10, 20, 50, 100]"
        (page)="onMatPage($event)"
        aria-label="Event pagination">
      </mat-paginator>
    </div>
  }
</div>
