@if (loading()) {
  <div class="loading-container animated-pulse">
    <div class="loading-icon-wrapper">
      <mat-progress-spinner color="primary" mode="indeterminate" diameter="50"></mat-progress-spinner>
    </div>
    <p class="loading-text">{{ 'VENUES.SECTOR_EDIT.LOADING' | translate }}</p>
  </div>
}

@if (error()) {
  <div class="error-container animate-fade-in">
    <mat-card appearance="outlined" class="error-card">
      <mat-card-content>
        <div class="error-icon-container">
          <mat-icon color="warn">error_outline</mat-icon>
        </div>
        <div class="error-message">
          <h3>{{ 'VENUES.SECTOR_EDIT.ERROR_TITLE' | translate }}</h3>
          <p>{{ error() }}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
}

@if (sector()) {
  <div class="sector-seat-editor animate-fade-in">
  <!-- Header with sector info and actions -->
  <div class="editor-header">
    <div class="sector-info">
      <h1 class="sector-name">
        <mat-icon>event_seat</mat-icon>
        {{ 'VENUES.SECTOR_EDIT.TITLE' | translate: {name: sector()?.name} }}
      </h1>
      <p class="venue-info">{{ 'VENUES.SECTOR_EDIT.VENUE_INFO' | translate: {venue: venue()?.name, city: venue()?.city, country: venue()?.country} }}</p>
      <p class="seat-count">{{ 'VENUES.SECTOR_EDIT.TOTAL_SEATS' | translate: {count: getTotalSeats()} }}</p>
    </div>
    
    <div class="header-actions">
      <button mat-stroked-button 
              color="warn" 
              (click)="cancelChanges()" 
              [disabled]="!hasChanges() || saving()">
        <mat-icon>cancel</mat-icon>
        {{ 'VENUES.SECTOR_EDIT.CANCEL_BTN' | translate }}
      </button>
      
      <button mat-raised-button 
              color="primary" 
              (click)="saveChanges()" 
              [disabled]="!hasChanges() || saving()">
        <mat-icon>save</mat-icon>
        @if (saving()) {
          <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
          {{ 'VENUES.SECTOR_EDIT.SAVING_BTN' | translate }}
        } @else {
          {{ 'VENUES.SECTOR_EDIT.SAVE_BTN' | translate }}
        }
      </button>
      
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        {{ 'VENUES.SECTOR_EDIT.BACK_BTN' | translate }}
      </button>
    </div>
  </div>

  <div class="editor-content">
    <!-- Toolbar -->
    <mat-card class="toolbar-card">
      <mat-card-content class="toolbar-content">
        <!-- Seat Actions -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>event_seat</mat-icon>
            {{ 'VENUES.SECTOR_EDIT.TOOLBAR.SEATS' | translate }}
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="addSeatInToolbarMode()"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.ADD_SEAT' | translate">
              <mat-icon>add</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="deleteSelectedSeats()"
                    [disabled]="selectedSeats().length === 0"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.DELETE_SEATS' | translate"
                    color="warn">
              <mat-icon>delete</mat-icon>
            </button>
            <div class="vertical-divider"></div>
          </div>
        </div>

        <!-- Row Actions -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>view_stream</mat-icon>
            {{ 'VENUES.SECTOR_EDIT.TOOLBAR.ROWS' | translate }}
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="addNewRow()"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.ADD_ROW' | translate">
              <mat-icon>add</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="addMultipleRows()"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.ADD_MULTIPLE_ROWS' | translate">
              <mat-icon>library_add</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="editSelectedRowName()"
                    [disabled]="selectedRows().length !== 1"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.EDIT_ROW_NAME' | translate">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="deleteSelectedRow()"
                    [disabled]="selectedRows().length !== 1"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.DELETE_ROW' | translate"
                    color="warn">
              <mat-icon>delete_forever</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="deleteSelectedRows()"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.DELETE_EMPTY_ROWS' | translate"
                    color="warn">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <div class="spacer"></div>

        <!-- Zoom Controls -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>zoom_in</mat-icon>
            {{ 'VENUES.SECTOR_EDIT.TOOLBAR.ZOOM' | translate }}
          </h3>
          <div class="zoom-controls">
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomOut()" 
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.ZOOM_OUT' | translate">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <div class="zoom-display">{{ zoom() | number:'1.1-2' }}x</div>
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomIn()" 
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.ZOOM_IN' | translate">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <button mat-stroked-button 
                    (click)="resetZoom()"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.RESET_ZOOM' | translate">
              {{ 'VENUES.SECTOR_EDIT.TOOLBAR.RESET' | translate }}
            </button>
          </div>
        </div>

        <!-- View Options -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>visibility</mat-icon>
            {{ 'VENUES.SECTOR_EDIT.TOOLBAR.VIEW' | translate }}
          </h3>
          <div class="view-toggles">
            <button mat-stroked-button 
                    [color]="showGrid() ? 'primary' : 'basic'"
                    (click)="toggleGrid()"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.TOGGLE_GRID' | translate">
              <mat-icon>grid_on</mat-icon>
              {{ 'VENUES.SECTOR_EDIT.TOOLBAR.GRID' | translate }} {{ showGrid() ? ('VENUES.SECTOR_EDIT.TOOLBAR.ON' | translate) : ('VENUES.SECTOR_EDIT.TOOLBAR.OFF' | translate) }}
            </button>
            <button mat-stroked-button
                    [color]="snapToGrid() ? 'primary' : 'basic'"
                    (click)="toggleSnapToGrid()"
                    [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.TOGGLE_SNAP' | translate">
              <mat-icon>grid_4x4</mat-icon>
              {{ 'VENUES.SECTOR_EDIT.TOOLBAR.SNAP' | translate }} {{ snapToGrid() ? ('VENUES.SECTOR_EDIT.TOOLBAR.ON' | translate) : ('VENUES.SECTOR_EDIT.TOOLBAR.OFF' | translate) }}
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Canvas Area -->
    <mat-card class="canvas-card">
      <mat-card-content class="canvas-content">
        <!-- Canvas -->
        <div class="sector-canvas-container" 
             (keydown)="$event.key === 'Escape' && deselectAll()"
             role="application"
             aria-label="Sector seat editor canvas">
          <div #canvasContainer 
               class="konva-canvas"
               style="width: 100%; height: 100%; min-height: 600px;">
            <!-- Konva canvas will be inserted here -->
          </div>
        </div>

        <!-- Selection Info Panel -->
        @if (selectedSeats().length > 0) {
          <div class="selection-panel">
            <div class="selection-info">
              @if (selectedSeats().length === 1) {
                <h4>
                  <mat-icon>info</mat-icon>
                  {{ 'VENUES.SECTOR_EDIT.INFO.SINGLE_SEAT_SELECTED' | translate: {seatNumber: selectedSeats()[0].orderNumber || 'Unknown', rowName: getRowNameForSeat(selectedSeats()[0])} }}
                </h4>
                <div class="seat-details">
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.SECTOR_EDIT.INFO.ROW_LABEL' | translate }}:</span>
                    <span class="detail-value">{{ getRowNameForSeat(selectedSeats()[0]) }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.SECTOR_EDIT.INFO.ORDER_LABEL' | translate }}:</span>
                    <span class="detail-value">{{ selectedSeats()[0].orderNumber ?? '-' }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.SECTOR_EDIT.INFO.POSITION_LABEL' | translate }}:</span>
                    <span class="detail-value">                  
                      X: {{ selectedSeats()[0].position?.x ?? 0 }}, 
                      Y: {{ selectedSeats()[0].position?.y ?? 0 }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.SECTOR_EDIT.INFO.PRICE_CATEGORY_LABEL' | translate }}:</span>
                    <span class="detail-value">{{ selectedSeats()[0].priceCategory || 'Standard' }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.SECTOR_EDIT.INFO.STATUS_LABEL' | translate }}:</span>
                    <span class="detail-value status" 
                          [class.active]="selectedSeats()[0].status === 'active'"
                          [class.inactive]="selectedSeats()[0].status === 'inactive'">
                      {{ selectedSeats()[0].status }}
                    </span>
                  </div>
                </div>
              } @else {
                <h4>
                  <mat-icon>info</mat-icon>
                  {{ 'VENUES.SECTOR_EDIT.INFO.MULTIPLE_SELECTED_TITLE' | translate: {count: selectedSeats().length} }}
                </h4>
                <div class="seat-details">
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.SECTOR_EDIT.INFO.SELECTION_LABEL' | translate }}:</span>
                    <span class="detail-value">
                      {{ getSelectedSeatInfo() }}
                    </span>
                  </div>
                </div>
              }
            </div>
            <button mat-icon-button (click)="deselectAll()" [matTooltip]="'VENUES.SECTOR_EDIT.TOOLBAR.DESELECT' | translate">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }

        <!-- Instructions -->
        <div class="instructions-panel">
          <div class="instruction-card">
            <mat-icon>info</mat-icon>
            <div class="instruction-content">
              <h4>{{ 'VENUES.SECTOR_EDIT.INSTRUCTIONS.TITLE' | translate }}</h4>
              <div class="instruction-list">
                <p [innerHTML]="'VENUES.SECTOR_EDIT.INSTRUCTIONS.SELECT' | translate"></p>
                <p [innerHTML]="'VENUES.SECTOR_EDIT.INSTRUCTIONS.RANGE_SELECT' | translate"></p>
                <p [innerHTML]="'VENUES.SECTOR_EDIT.INSTRUCTIONS.ROW_SELECT' | translate"></p>
                <p [innerHTML]="'VENUES.SECTOR_EDIT.INSTRUCTIONS.COLUMN_SELECT' | translate"></p>
                <p [innerHTML]="'VENUES.SECTOR_EDIT.INSTRUCTIONS.MOVE' | translate"></p>
                <p [innerHTML]="'VENUES.SECTOR_EDIT.INSTRUCTIONS.DELETE' | translate"></p>
              </div>
            </div>
          </div>

          @if (isCtrlPressed()) {
            <div class="ctrl-indicator">
              <mat-icon color="primary">keyboard</mat-icon>
              <span>{{ 'VENUES.SECTOR_EDIT.INSTRUCTIONS.MULTI_SELECT_ACTIVE' | translate }}</span>
            </div>
          }

          @if (isShiftPressed()) {
            <div class="shift-indicator">
              <mat-icon color="accent">keyboard</mat-icon>
              <span>{{ 'VENUES.SECTOR_EDIT.INSTRUCTIONS.RANGE_SELECT_ACTIVE' | translate }}</span>
            </div>
          }

          @if (hasChanges()) {
            <div class="changes-indicator">
              <mat-icon color="warn">warning</mat-icon>
              <span>{{ 'VENUES.SECTOR_EDIT.INSTRUCTIONS.UNSAVED_CHANGES' | translate }}</span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
    
    <!-- Import layout card (bottom) -->
    <mat-card class="import-layout-card">
      <mat-card-header>
        <mat-card-title>
          <h3 class="tool-group-title" style="display:flex;align-items:center;gap:.25rem;">
            <mat-icon>file_upload</mat-icon>
            {{ 'VENUES.SECTOR_EDIT.IMPORT.TITLE' | translate }}
          </h3>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="import-controls">
          <textarea
            class="import-textarea"
            rows="4"
            [placeholder]="'VENUES.SECTOR_EDIT.IMPORT.PLACEHOLDER' | translate"
            [(ngModel)]="importJsonText">
          </textarea>
          <div class="import-actions">
            <button
              mat-stroked-button
              color="primary"
              class="import-primary-button"
              (click)="onImportSectorLayoutJson()"
              [disabled]="!importJsonText || saving()"
              [matTooltip]="'VENUES.SECTOR_EDIT.IMPORT.TOOLTIP' | translate">
              <mat-icon>download</mat-icon>
              {{ 'VENUES.SECTOR_EDIT.IMPORT.BUTTON' | translate }}
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  </div>
}
