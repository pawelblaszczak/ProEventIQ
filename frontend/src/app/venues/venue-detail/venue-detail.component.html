<div *ngIf="loading()" class="loading-container animated-pulse">
  <div class="loading-icon-wrapper">
    <mat-progress-spinner color="primary" mode="indeterminate" diameter="50"></mat-progress-spinner>
  </div>
  <p class="loading-text">Loading venue details...</p>
  <div class="loading-progress-dots">
    <span class="dot"></span>
    <span class="dot"></span>
    <span class="dot"></span>
  </div>
</div>

<div *ngIf="error()" class="error-container animate-fade-in">
  <mat-card appearance="outlined" class="error-card">
    <mat-card-content>
      <div class="error-icon-container">
        <mat-icon color="warn">error_outline</mat-icon>
      </div>
      <div class="error-message">
        <h3>Error Loading Venue</h3>
        <p>{{ error() }}</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<div *ngIf="venue()" class="venue-details-section animate-fade-in">
  <mat-card appearance="outlined" class="venue-details-card mat-elevation-z3">
    <div class="venue-hero" [ngClass]="{'has-image': venue()?.thumbnail}">
      <div class="venue-header-content">
        <h1 class="venue-name">{{ venue()?.name }}</h1>
        <h2 class="venue-location">
          <mat-icon class="location-icon">location_on</mat-icon>
          {{ venue()?.city }}, {{ venue()?.country }}
        </h2>        <div class="venue-stats">
          <div class="stat-item">
            <mat-icon>grid_view</mat-icon>
            <div class="stat-content">
              <span class="stat-inline">{{ venue()?.sectors?.length || 0 }} Sectors</span>
            </div>
          </div>
          <div class="stat-item">
            <mat-icon>event_seat</mat-icon>
            <div class="stat-content">
              <span class="stat-inline">{{ venue()?.numberOfSeats | number }} Seats</span>
            </div>
          </div>
        </div>
      </div>
      
      <div *ngIf="venue()?.thumbnail" class="venue-image-container">
        <img class="venue-hero-image" 
             [src]="'data:' + venue()?.thumbnailContentType + ';base64,' + venue()?.thumbnail" 
             [alt]="venue()?.name + ' thumbnail'">
      </div>
      <div *ngIf="!venue()?.thumbnail" class="venue-image-placeholder">
        <mat-icon class="placeholder-icon" style="font-size: 72px; color: #bdbdbd;">image_not_supported</mat-icon>
        <p>No image available</p>
      </div>
    </div>
    
    <mat-divider></mat-divider>
    
    <mat-card-content class="venue-details-content">
      <h3 class="section-title">
        <mat-icon>info</mat-icon>
        Venue Details
      </h3>
      
      <div class="venue-info-grid">
        <div class="info-item">
          <div class="info-label">Address</div>
          <div class="info-value">{{ getFullAddress() }}</div>
        </div>
        
        <div class="info-item full-width">
          <div class="info-label">Description</div>
          <div class="info-value description">{{ venue()?.description || 'No description available' }}</div>
        </div>
      </div>
    </mat-card-content>
      <mat-card-actions class="venue-actions" align="end">
      <button mat-stroked-button 
              color="warn" 
              (click)="onDelete()" 
              class="delete-button"
              [disabled]="loading()">
        <mat-icon>delete</mat-icon>
        DELETE VENUE
      </button>
      <button mat-stroked-button routerLink="/venues" class="back-button">
        <mat-icon>arrow_back</mat-icon>
        BACK TO LIST
      </button>
      <button mat-raised-button color="primary" [routerLink]="['/venues', venue()?.venueId, 'edit']" aria-label="Edit venue" class="edit-button">
        <mat-icon>edit</mat-icon>
        EDIT VENUE
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<mat-card appearance="outlined" class="venue-map-card mat-elevation-z3">  <div class="card-header-banner">
    <div class="header-content">
      <div class="title-with-icon">
        <mat-icon class="title-icon">map</mat-icon>
        <div>
          <h2 class="banner-title">Venue Map</h2>
          <p class="banner-subtitle">Interactive venue visualization</p>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button mat-stroked-button color="primary" class="edit-map-btn" [routerLink]="['/venues', venue()?.venueId, 'map-edit']" aria-label="Edit venue map">
        <mat-icon>edit</mat-icon>
        Edit Map
      </button>
    </div>
  </div>
  
  <mat-card-content class="map-content">
    <div class="controls-container">
      <div class="zoom-controls">
        <button mat-mini-fab color="primary" (click)="zoomOut()" aria-label="Zoom out" class="zoom-button">
          <mat-icon>zoom_out</mat-icon>
        </button>
        <div class="zoom-badge">
          <span class="zoom-level">{{ zoom() | number:'1.1-2' }}x</span>
        </div>
        <button mat-mini-fab color="primary" (click)="zoomIn()" aria-label="Zoom in" class="zoom-button">
          <mat-icon>zoom_in</mat-icon>
        </button>
      </div>
    </div>
    <div class="venue-canvas-container" style="height: 600px;">
      <ko-stage [config]="{ width: canvasWidth, height: canvasHeight, draggable: true, scaleX: zoom(), scaleY: zoom() }">
        <ko-layer>
          <ng-container *ngIf="venue() && venue()?.sectors">            <!-- Zoomed out view - show sectors as boxes -->            @if (!showSeats()) {
              <ko-group *ngFor="let sector of venue()?.sectors || []; let i = index" 
                       [config]="{ x: getSectorPositionValue(sector, 'x'), y: getSectorPositionValue(sector, 'y'), draggable: false }">
                <ko-rect [config]="{ 
                  width: 100, 
                  height: 60, 
                  fill: '#90caf9', 
                  stroke: '#1976d2', 
                  strokeWidth: 2, 
                  cornerRadius: 8 
                }"></ko-rect>
                <ko-text [config]="{ 
                  text: sector.name, 
                  x: 10, 
                  y: 20, 
                  fontSize: 16, 
                  fill: '#0d47a1', 
                  fontStyle: 'bold' 
                }"></ko-text>
                <ko-text [config]="{ 
                  text: 'Seats: ' + (sector.numberOfSeats || 0), 
                  x: 10, 
                  y: 40, 
                  fontSize: 12, 
                  fill: '#333' 
                }"></ko-text>
              </ko-group>
            } @else {              <!-- Zoomed in view - show detailed seats -->
              @for (sector of venue()?.sectors || []; track sector.sectorId) {
                @if (sector.position) {
                  <ko-group [config]="{ x: getSectorPositionValue(sector, 'x'), y: getSectorPositionValue(sector, 'y'), draggable: false }">
                    <!-- Sector label -->
                    <ko-text [config]="{ 
                      text: sector.name, 
                      x: 0, 
                      y: 0, 
                      fontSize: 14, 
                      fill: '#0d47a1', 
                      fontStyle: 'bold' 
                    }"></ko-text>
                    
                    <!-- No rows message -->
                    @if (!sector.rows || sector.rows.length === 0) {
                      <ko-text [config]="{
                        text: 'No rows available for this sector',
                        x: 0,
                        y: 30,
                        fontSize: 12,
                        fill: '#f44336'
                      }"></ko-text>
                    }
                    
                    <!-- Show rows if available -->
                    @for (row of sector.rows || []; track row.seatRowId) {
                      <ko-group>                        <!-- Row label -->
                        <ko-text [config]="{ 
                          text: row.name || 'Row', 
                          x: -20, 
                          y: getRowLabelPosition(row), 
                          fontSize: 10, 
                          fill: '#333' 
                        }"></ko-text>
                          <!-- No seats message -->
                        @if (!row.seats || row.seats.length === 0) {
                          <ko-text [config]="{
                            text: 'No seats available for this row',
                            x: 0,
                            y: 30,
                            fontSize: 12,
                            fill: '#f44336'
                          }"></ko-text>
                        }
                        
                        <!-- Show seats if available -->
                        @for (seat of row.seats || []; track seat.seatId) {
                          @if (seat.position) {
                            <ko-rect 
                              [config]="{
                                x: getSeatPositionValue(seat, 'x'),
                                y: getSeatPositionValue(seat, 'y'),
                                width: 8,
                                height: 8,
                                fill: getSeatColor(seat),
                                stroke: '#333',
                                strokeWidth: 1,
                                cornerRadius: 2
                              }"
                              (mouseover)="onSeatHover($event, seat, row.name)"
                              onFocus>
                            </ko-rect>
                            
                            <!-- Seat number label -->
                            <ko-text 
                              [config]="{ 
                                text: (seat.orderNumber || '').toString(),
                                x: getSeatPositionValue(seat, 'x'),
                                y: getSeatPositionValue(seat, 'y') + 5,
                                fontSize: 6,
                                fill: '#000',
                                align: 'center',
                                width: 8
                              }">
                            </ko-text>
                          }
                        }
                      </ko-group>
                    }
                  </ko-group>
                }
              }
            }
          </ng-container>
        </ko-layer>
      </ko-stage>
    </div>    <div class="map-instructions">
      <div class="instruction-card" *ngIf="!showSeats()">
        <div class="instruction-icon">
          <mat-icon>touch_app</mat-icon>
        </div>
        <div class="instruction-content">
          <h4>Tip: Zoom In for Details</h4>
          <p>Zoom in (>1.5x) to see individual seats within each sector.</p>
        </div>
      </div>
      
      <div class="instruction-card" *ngIf="showSeats()">
        <div class="instruction-icon">
          <mat-icon>zoom_out_map</mat-icon>
        </div>
        <div class="instruction-content">
          <h4>Detailed Seat View</h4>
          <p>Currently showing all seats. Zoom out (<1.5x) to see sector overview.</p>
        </div>
      </div>
      
      <div *ngIf="venue()?.sectors?.length && !hasCompleteData()" class="warning-card">
        <div class="warning-icon">
          <mat-icon color="warn">warning</mat-icon>
        </div>
        <div class="warning-content">
          <h4>Limited Data Available</h4>
          <p>Some sectors or seats may not be displayed due to missing position data.</p>
        </div>
      </div>
    </div>
      <div *ngIf="showSeats()" class="legend-container">
      <div class="legend-header">
        <mat-icon>format_color_fill</mat-icon>
        <h3>Seat Legend</h3>
      </div>
      <div class="seat-legend">
        <div class="legend-item">
          <div class="color-box active"></div>
          <span>Active seat</span>
        </div>
        <div class="legend-item">
          <div class="color-box inactive"></div>
          <span>Inactive seat</span>
        </div>
      </div>    </div>
  </mat-card-content>
</mat-card>
