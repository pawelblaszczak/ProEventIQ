<div *ngIf="loading()" class="loading-container animated-pulse">
  <div class="loading-icon-wrapper">
    <mat-progress-spinner color="primary" mode="indeterminate" diameter="50"></mat-progress-spinner>
  </div>
  <p class="loading-text">{{ mode === 'preview' ? ('VENUES.MAP.LOADING_MAP' | translate) : ('VENUES.MAP.LOADING_EDIT' | translate) }}</p>
</div>

<app-error-display 
  *ngIf="error()" 
  [error]="error()!" 
  [title]="'VENUES.MAP.ERROR_TITLE' | translate">
</app-error-display>

<div *ngIf="venue()" class="venue-map-editor animate-fade-in" 
  [class.reservation-mode]="mode==='reservation' || mode==='reservation-preview'"
  [class.preview-mode]="mode==='preview'">
  <!-- Header with venue info and actions (edit & interactive reservation modes only) -->
  <div class="editor-header" *ngIf="mode === 'edit' || mode === 'reservation'">
    <div class="venue-info">
      <h1 class="venue-name">
        <mat-icon>{{ mode === 'edit' ? 'edit' : 'event_seat' }}</mat-icon>
        @if (mode === 'edit') {
          {{ 'VENUES.MAP.EDITING' | translate }}: {{ venue()?.name }}
        } @else {
          {{ 'VENUES.MAP.RESERVATIONS' | translate }}: {{ eventData?.showName || venue()?.name }}
          <span *ngIf="eventData?.dateTime" class="event-date">{{ eventData?.dateTime | date:'mediumDate' }}</span>
        }
      </h1>
      <p class="venue-location">
  @if (isReservationLike()) {
          {{ venue()?.name }}
          <span *ngIf="venue()?.address"> – {{ venue()?.address }}</span>
          <span *ngIf="venue()?.city">, {{ venue()?.city }}</span>
          <span *ngIf="venue()?.country">, {{ venue()?.country }}</span>
        } @else {
          {{ venue()?.city }}, {{ venue()?.country }}
        }
      </p>
    </div>
    <div class="header-actions">
  <!-- Show Cancel & Save in both edit and reservation modes (not in preview) -->
  @if (mode === 'edit' || mode === 'reservation') {
        <button mat-stroked-button 
                color="warn" 
                (click)="cancelReservationChangesPublic()" 
                [disabled]="((mode === 'reservation') ? !hasReservationChanges() : !hasAnyChanges()) || saving()">
          <mat-icon>cancel</mat-icon>
          {{ 'VENUES.MAP.CANCEL' | translate }}
        </button>
        <button mat-raised-button 
                color="primary" 
                (click)="saveReservationChangesPublic()" 
                [disabled]="((mode === 'reservation') ? !hasReservationChanges() : !hasAnyChanges()) || saving()">
          <mat-icon>save</mat-icon>
          @if (saving()) {
            <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
            {{ 'VENUES.MAP.SAVING' | translate }}
          } @else {
            {{ 'VENUES.MAP.SAVE_CHANGES' | translate }}
          }
        </button>
      }
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        {{ 'VENUES.MAP.BACK' | translate }}
      </button>
    </div>
  </div>

  <div class="editor-content">
    <!-- Toolbar -->
    <mat-card class="toolbar-card">
      <mat-card-content class="toolbar-content">
          <!-- Allocation Actions (only in reservation mode) - moved to leftmost position -->
          <div class="tool-group" *ngIf="mode === 'reservation'">
            <h3 class="tool-group-title">
              <mat-icon>done_all</mat-icon>
              {{ 'VENUES.MAP.ALLOCATE_ALL' | translate }}
            </h3>
            <div class="tool-buttons">
              <button mat-icon-button
                      (click)="allocateAll()"
                      [matTooltip]="'VENUES.MAP.ALLOCATE_ALL' | translate">
                <mat-icon>done_all</mat-icon>
              </button>
              <button mat-icon-button
                      (click)="clearAllAllocations()"
                      [matTooltip]="'VENUES.MAP.CLEAR_ALL' | translate"
                      color="warn">
                <mat-icon>clear_all</mat-icon>
              </button>
              <div class="vertical-divider"></div>
            </div>
          </div>
        
        <!-- Edit Mode Toggle (only in edit mode) - moved to first position -->
        <div class="tool-group" *ngIf="mode === 'edit'">
          <h3 class="tool-group-title">
            <mat-icon fontSet="material-icons-outlined">{{ editMode() === 'sectors' ? 'grid_view' : 'label' }}</mat-icon>
            {{ 'VENUES.MAP.EDIT_MODE' | translate }}
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    [class.active-mode]="editMode() === 'sectors'"
                    (click)="onEditModeChange('sectors')"
                    [matTooltip]="'VENUES.MAP.EDIT_SECTORS_MODE' | translate">
              <mat-icon>grid_view</mat-icon>
            </button>
            <button mat-icon-button 
                    [class.active-mode]="editMode() === 'labels'"
                    (click)="onEditModeChange('labels')"
                    [matTooltip]="'VENUES.MAP.EDIT_LABELS_MODE' | translate">
              <mat-icon fontSet="material-icons-outlined">label</mat-icon>
            </button>
            <div class="vertical-divider"></div>
          </div>
        </div>

          <div class="tool-group" *ngIf="mode === 'reservation'">
            <h3 class="tool-group-title">
              <mat-icon>done_outline</mat-icon>
              {{ 'VENUES.MAP.ALLOCATE_SELECTED' | translate }}
            </h3>
            <div class="tool-buttons">
              <button mat-icon-button
                      (click)="allocateSelected(false)"
                      [matTooltip]="'VENUES.MAP.ALLOCATE_FORWARD' | translate">
                <mat-icon>arrow_upward</mat-icon>
              </button>
              <button mat-icon-button
                      (click)="allocateSelected(true)"
                      [matTooltip]="'VENUES.MAP.ALLOCATE_REVERSE' | translate">
                <mat-icon>arrow_downward</mat-icon>
              </button>
              <button mat-icon-button
                      (click)="clearSelectedAllocations()"
                      [matTooltip]="'VENUES.MAP.CLEAR_SELECTED' | translate"
                      color="warn">
                <mat-icon color="warn">remove</mat-icon>
              </button>
              <div class="vertical-divider"></div>
            </div>
          </div>
        <!-- Sector Actions (only in edit mode and when editing sectors, not labels) -->
        <div class="tool-group" *ngIf="mode === 'edit' && editMode() === 'sectors'">
          <h3 class="tool-group-title">
            <mat-icon>grid_view</mat-icon>
            {{ 'VENUES.MAP.SECTORS' | translate }}
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="addNewSector()"
                    [matTooltip]="'VENUES.MAP.ADD_SECTOR' | translate">
              <mat-icon>add</mat-icon>
            </button>
      <button mat-icon-button 
        (click)="duplicateSector()"
        [disabled]="!canDuplicateSelectedSectors()"
        [matTooltip]="'VENUES.MAP.DUPLICATE_SECTOR' | translate">
              <mat-icon>content_copy</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="editSectorSeats()"
                    [disabled]="selectedSectors().length !== 1"
                    [matTooltip]="'VENUES.MAP.EDIT_SEATS' | translate">
              <mat-icon>event_seat</mat-icon>
            </button>
            <!-- Change Name button removed per request -->
            <button mat-icon-button 
                    (click)="deleteSector()"
                    [disabled]="selectedSectors().length === 0"
                    [matTooltip]="'VENUES.MAP.DELETE_SECTOR' | translate"
                    color="warn">
              <mat-icon>delete</mat-icon>
            </button>
            <div class="vertical-divider"></div>
          </div>
        </div>

        

        <!-- Rotation Controls (show in edit mode; disable when nothing selected) -->
        <div class="tool-group" *ngIf="mode === 'edit'">
          <h3 class="tool-group-title">
            <mat-icon>rotate_right</mat-icon>
            Rotate
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="editMode() === 'sectors' ? rotateSector(false) : rotateLabel(false)"
                    [disabled]="selectedSectors().length === 0"
                    [matTooltip]="'VENUES.MAP.ROTATE_LEFT' | translate">
              <mat-icon>rotate_left</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="editMode() === 'sectors' ? rotateSector(true) : rotateLabel(true)"
                    [disabled]="selectedSectors().length === 0"
                    [matTooltip]="'VENUES.MAP.ROTATE_RIGHT' | translate">
              <mat-icon>rotate_right</mat-icon>
            </button>
            <div class="vertical-divider"></div>
          </div>
        </div>

        <!-- Font Size Controls (only when in label edit mode) -->
        <div class="tool-group" *ngIf="mode === 'edit' && editMode() === 'labels'">
          <h3 class="tool-group-title">
            <mat-icon>format_size</mat-icon>
            {{ 'VENUES.MAP.FONT_SIZE' | translate }}
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="changeLabelFontSize(false)"
                    [disabled]="selectedSectors().length === 0"
                    [matTooltip]="'VENUES.MAP.DECREASE_FONT_SIZE' | translate">
              <mat-icon>text_decrease</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="changeLabelFontSize(true)"
                    [disabled]="selectedSectors().length === 0"
                    [matTooltip]="'VENUES.MAP.INCREASE_FONT_SIZE' | translate">
              <mat-icon>text_increase</mat-icon>
            </button>
          </div>
        </div>

        <div class="spacer"></div>

        <!-- Zoom Controls (always visible) -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>zoom_in</mat-icon>
            {{ 'VENUES.MAP.ZOOM' | translate }}
          </h3>
          <div class="zoom-controls">
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomOut()" 
                    [disabled]="getCurrentZoom() <= minZoomValue"
                    [matTooltip]="'VENUES.MAP.ZOOM_OUT' | translate">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <span class="zoom-input-group">
              <input type="number" 
                     class="zoom-input"
                     [value]="(getCurrentZoom() * 100) | number:'1.0-0'" 
                     (input)="setZoomFromInput($any($event.target).value)"
                     [min]="minZoomValue * 100"
                     [max]="maxZoomValue * 100"
                     step="10">
            </span>
            <span class="zoom-label">%</span>
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomIn()" 
                    [disabled]="getCurrentZoom() >= maxZoomValue"
                    [matTooltip]="'VENUES.MAP.ZOOM_IN' | translate">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <div class="vertical-divider"></div>
          </div>
        </div>
        <!-- Canvas Dimensions -->
        <div class="tool-group" *ngIf="mode === 'edit'">
          <h3 class="tool-group-title">
            <mat-icon>aspect_ratio</mat-icon>
            {{ 'VENUES.MAP.CANVAS' | translate }}
          </h3>
          <div class="tool-buttons">
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="dimension-input">
                <mat-label>{{ 'VENUES.MAP.WIDTH' | translate }}</mat-label>
                <input matInput type="number" [ngModel]="baseCanvasWidth()" (ngModelChange)="updateCanvasDimensions($event, baseCanvasHeight())" [disabled]="mode !== 'edit'">
            </mat-form-field>
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="dimension-input">
                <mat-label>{{ 'VENUES.MAP.HEIGHT' | translate }}</mat-label>
                <input matInput type="number" [ngModel]="baseCanvasHeight()" (ngModelChange)="updateCanvasDimensions(baseCanvasWidth(), $event)" [disabled]="mode !== 'edit'">
            </mat-form-field>
            <div class="vertical-divider"></div>
          </div>
        </div>

        <!-- View Options (always visible) -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>visibility</mat-icon>
            {{ 'VENUES.MAP.VIEW' | translate }}
          </h3>
          <div class="tool-buttons">
            <mat-form-field appearance="outline" subscriptSizing="dynamic" class="view-select">
              <mat-label>{{ 'VENUES.MAP.LABELS' | translate }}</mat-label>
              <mat-select [value]="sectorLabelMode()" (selectionChange)="setSectorLabelMode($event.value)" panelClass="labels-select-panel">
                <mat-option value="auto">{{ 'VENUES.MAP.LABEL_AUTO' | translate }}</mat-option>
                <mat-option value="name">{{ 'VENUES.MAP.LABEL_NAME' | translate }}</mat-option>
                <mat-option value="name_seats">{{ 'VENUES.MAP.LABEL_NAME_SEATS' | translate }}</mat-option>
                <mat-option value="none">{{ 'VENUES.MAP.LABEL_NONE' | translate }}</mat-option>
              </mat-select>
            </mat-form-field>            
            <button mat-icon-button 
                    class="view-toggle-btn"
                    [color]="showSeats() ? 'primary' : ''"
                    (click)="toggleSeats()"
                    [matTooltip]="'VENUES.MAP.TOGGLE_SEATS' | translate">
              <mat-icon>event_seat</mat-icon>
            </button>
            <button mat-icon-button 
                    class="view-toggle-btn"
                    [color]="showOrders() ? 'primary' : ''"
                    (click)="toggleOrders()"
                    [matTooltip]="'VENUES.MAP.TOGGLE_ORDERS' | translate">
              <mat-icon>format_list_numbered</mat-icon>
            </button>
            <button mat-icon-button 
                    class="view-toggle-btn"
                    [color]="showGrid() ? 'primary' : ''"
                    (click)="toggleGridDebug()"
                    [matTooltip]="'VENUES.MAP.TOGGLE_GRID' | translate">
              <mat-icon>grid_on</mat-icon>
            </button>
          </div>
        </div>
        
      </mat-card-content>
    </mat-card>

    <!-- Canvas Area -->
    <!-- Map row (canvas + optional reservation sidebar) -->
  <div class="map-row" [class.with-reservation]="mode==='reservation' || mode==='reservation-preview'">
      <mat-card class="canvas-card">
        <mat-card-content class="canvas-content">
          <!-- Canvas -->
          <div class="venue-canvas-container custom-scroll-canvas" 
               role="application"
               [attr.aria-label]="'VENUES.MAP.ARIA_CANVAS' | translate">
            <div #canvasContainer 
                 class="konva-canvas">
            </div>
          </div>

  <!-- Selection Info Panel was moved out of the canvas card and is rendered as a right-side panel when in edit mode -->

        <!-- Instructions -->
        <div class="instructions-panel" *ngIf="mode === 'edit'">
          <div class="instruction-card">
            <mat-icon>info</mat-icon>
            <div class="instruction-content">
              <h4>{{ 'VENUES.MAP.HOW_TO_EDIT' | translate }}</h4>
              <p [innerHTML]="'VENUES.MAP.INSTRUCTIONS_EDIT' | translate"></p>
              <p [innerHTML]="'VENUES.MAP.INSTRUCTIONS_ZOOM' | translate"></p>
            </div>
          </div>

          @if (isCtrlPressed()) {
            <div class="ctrl-indicator">
              <mat-icon color="primary">keyboard</mat-icon>
              <span>{{ 'VENUES.MAP.MULTI_SELECT_ACTIVE' | translate }}</span>
            </div>
          }

          @if (hasAnyChanges()) {
            <div class="changes-indicator">
              <mat-icon color="warn">warning</mat-icon>
              <span>{{ 'VENUES.MAP.UNSAVED_CHANGES' | translate }}</span>
            </div>
          }
        </div>
        </mat-card-content>
      </mat-card>

      <!-- Reservation side panel (right side) -->
  @if (mode === 'reservation') {
        <mat-card class="reservation-panel-card narrow">
          <mat-card-header>
            <mat-card-title style="display:flex;align-items:center;gap:.5rem;">
              <mat-icon>group</mat-icon>
              {{ 'VENUES.MAP.PARTICIPANTS' | translate }}
            </mat-card-title>
          </mat-card-header>
        <mat-card-content class="reservation-panel-content">
          @if (participantsLoading()) {
            <div class="side-loading">
              <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
              <p>{{ 'VENUES.MAP.LOADING_PARTICIPANTS' | translate }}</p>
            </div>
          } @else if (participantsError()) {
            <div class="side-error">
              <mat-icon color="warn">error_outline</mat-icon>
              <p>{{ participantsError() }}</p>
            </div>
          } @else {
            <div class="participants-list simple" role="list" aria-label="Participants">
              @if (!participants().length) {
                <div class="side-empty" style="padding: 20px; display: flex; flex-direction: column; align-items: center; color: #666;">
                  <mat-icon style="margin-bottom: 8px; opacity: 0.7;">info</mat-icon>
                  <p style="margin: 0;">{{ 'VENUES.MAP.NO_PARTICIPANTS' | translate }}</p>
                </div>
              }
              <div 
                class="participant-row" 
                *ngFor="let p of participants()" 
                matTooltip="{{ p.name }} ({{ p.allTicketCount }} tickets)"
                role="listitem"
                tabindex="0"
                (click)="onParticipantClick(p)"
                (keydown.enter)="onParticipantKey(p, $event)"
                (keydown.space)="onParticipantKey(p, $event)"
                [class.selected]="isParticipantSelected(p)"
                [attr.aria-selected]="isParticipantSelected(p)"
              >
                <div class="color" [style.background]="p.seatColor || '#bbb'"></div>
                <div class="name one-line">{{ p.name }}</div>
                <div class="seats-info" style="font-size: 0.95em; color: #666; margin-left: 0.5rem;">
                  {{ getReservedSeatsForParticipant(p) }}/{{ p.allTicketCount }}
                </div>                
              </div>
              
              <mat-divider *ngIf="participants().length" class="participant-separator" style="margin: 0.5rem 0;"></mat-divider>

              <div 
                class="participant-row blocked-row" 
                [matTooltip]="'VENUES.MAP.BLOCKED_SEATS' | translate"
                role="listitem"
                tabindex="0"
                (click)="onBlockedClick()"
                (keydown.enter)="onBlockedClick()"
                (keydown.space)="onBlockedClick()"
                [class.selected]="isBlockedSelected()"
                [attr.aria-selected]="isBlockedSelected()"
              >
                 <div class="color blocked-color" style="background: #333;"></div>
                 <div class="name one-line">{{ 'VENUES.MAP.BLOCKED' | translate }}</div>
                 <div class="seats-info" style="font-size: 0.95em; color: #666; margin-left: 0.5rem;">
                  {{ getBlockedSeatsCount() }}
                </div>
              </div>
            </div>
          }
          </mat-card-content>
        </mat-card>
      }

      <!-- Selection side panel (right side, visible in edit mode) -->
      @if (mode === 'edit' && selectedSectors().length > 0) {
        <mat-card class="reservation-panel-card narrow selection-panel-card">
          <mat-card-header>
            <div style="display:flex;align-items:center;justify-content:space-between;width:100%;">
              <mat-card-title class="selection-card-title" style="display:flex;align-items:center;gap:.5rem;">
                <mat-icon class="selection-card-icon">info</mat-icon>
                {{ 'VENUES.MAP.SELECTED' | translate }}
              </mat-card-title>
              <button mat-icon-button color="primary" [attr.aria-label]="'VENUES.MAP.DESELECT' | translate" (click)="deselectAll()" class="selection-deselect-btn">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </mat-card-header>
          <mat-card-content class="reservation-panel-content">
            <div class="selection-info">
              @if (selectedSectors().length === 1) {
                <div class="sector-details">
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.NAME' | translate }}:</span>
                    <!-- When editing, place the input on a full-width row below the label -->
                    <ng-container *ngIf="editingSectorId() === selectedSectors()[0].sectorId; else nameView">
                      <div class="inline-edit-row">
                        <input class="inline-edit-input" type="text"
                               [value]="editingSectorName()"
                               (input)="editingSectorName.set($any($event.target).value)"
                               (keydown.enter)="commitInlineEdit()"
                               (keydown.escape)="cancelInlineEdit()"
                               [attr.aria-label]="'VENUES.MAP.EDIT_NAME' | translate" />
                      </div>
                      <div class="inline-edit-actions below">
                        <button mat-icon-button color="primary" [attr.aria-label]="'VENUES.MAP.ACCEPT_CHANGE' | translate" (click)="commitInlineEdit()" [matTooltip]="'VENUES.MAP.ACCEPT' | translate">
                          <mat-icon>done</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" [attr.aria-label]="'VENUES.MAP.REJECT_CHANGE' | translate" (click)="cancelInlineEdit()" [matTooltip]="'VENUES.MAP.REJECT' | translate">
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>
                    </ng-container>
                    <ng-template #nameView>
                      <span class="detail-value">
                        <span class="name-text">{{ selectedSectors()[0].name }}</span>
                        <button mat-icon-button color="primary" class="inline-edit-btn" [attr.aria-label]="'VENUES.MAP.EDIT_NAME' | translate" (click)="startInlineEdit(selectedSectors()[0])" [matTooltip]="'VENUES.MAP.EDIT_NAME' | translate">
                          <mat-icon>edit</mat-icon>
                        </button>
                      </span>
                    </ng-template>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.ORDER' | translate }}:</span>
                    <!-- Inline edit for order number -->
                    <ng-container *ngIf="editingOrderSectorId() === selectedSectors()[0].sectorId; else orderView">
                      <div class="inline-edit-row">
         <input class="inline-edit-input" type="number" step="1"
           [min]="1"
           [max]="getMaxOrder()"
                               [value]="editingSectorOrder()"
                               (input)="onOrderInput($any($event.target).value)"
                               (keydown.enter)="commitInlineOrderEdit()"
                               (keydown.escape)="cancelInlineOrderEdit()"
                               [attr.aria-label]="'VENUES.MAP.EDIT_ORDER' | translate" />
                      </div>
                      <div class="inline-edit-actions below">
                        <button mat-icon-button color="primary" [attr.aria-label]="'VENUES.MAP.ACCEPT_CHANGE' | translate" (click)="commitInlineOrderEdit()" [matTooltip]="'VENUES.MAP.ACCEPT' | translate">
                          <mat-icon>done</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" [attr.aria-label]="'VENUES.MAP.REJECT_CHANGE' | translate" (click)="cancelInlineOrderEdit()" [matTooltip]="'VENUES.MAP.REJECT' | translate">
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>
                    </ng-container>
                    <ng-template #orderView>
                      <span class="detail-value">
                        <span class="name-text">{{ selectedSectors()[0].orderNumber ?? '-' }}</span>
                        <button mat-icon-button color="primary" class="inline-edit-btn" [attr.aria-label]="'VENUES.MAP.EDIT_ORDER' | translate" (click)="startInlineOrderEdit(selectedSectors()[0])" [matTooltip]="'VENUES.MAP.EDIT_ORDER' | translate">
                          <mat-icon>edit</mat-icon>
                        </button>
                      </span>
                    </ng-template>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.POSITION' | translate }}:</span>
                    <span class="detail-value">                  
                      X: {{ selectedSectors()[0].position?.x ?? 0 }}, 
                      Y: {{ selectedSectors()[0].position?.y ?? 0 }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.ROTATION' | translate }}:</span>
                    <span class="detail-value">{{ selectedSectors()[0].rotation }}°</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.SEATS' | translate }}:</span>
                    <span class="detail-value">{{ selectedSectors()[0].numberOfSeats ?? 0 }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.STATUS' | translate }}:</span>
                    <span class="detail-value status" 
                          [class.active]="selectedSectors()[0].status === 'active'"
                          [class.inactive]="selectedSectors()[0].status === 'inactive'">
                      {{ selectedSectors()[0].status }}
                    </span>
                  </div>
                </div>
              } @else {
                <h4 class="selection-subtitle">{{ 'VENUES.MAP.MULTIPLE_SELECTED' | translate }} ({{ selectedSectors().length }})</h4>
                <div class="sector-details">
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.SECTORS' | translate }}:</span>
                    <span class="detail-value">
                      {{ getSelectedSectorNames() }}
                    </span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">{{ 'VENUES.MAP.TOTAL_SEATS' | translate }}:</span>
                    <span class="detail-value">
                      {{ getTotalSelectedSeats() }}
                    </span>
                  </div>
                </div>
              }
            </div>
            <!-- old bottom deselect button removed; use header button instead -->
          </mat-card-content>
        </mat-card>
      }
    </div>
  </div>
  
  <!-- Import layout card (bottom, only in edit mode) -->
  <mat-card class="import-layout-card" *ngIf="mode === 'edit'">
    <mat-card-header>
      <mat-card-title>
        <h3 class="tool-group-title" style="display:flex;align-items:center;gap:.25rem;">
          <mat-icon>file_upload</mat-icon>
          {{ 'VENUES.MAP.IMPORT_LAYOUT' | translate }}
        </h3>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="import-controls">
        <textarea
          class="import-textarea"
          rows="4"
          [placeholder]="'VENUES.MAP.PASTE_JSON' | translate"
          [(ngModel)]="importJsonText">
        </textarea>
        <div class="import-actions">
          <button
            mat-stroked-button
            color="primary"
            class="import-primary-button"
            (click)="onImportVenueJson()"
            [disabled]="!importJsonText || saving()"
            [matTooltip]="'VENUES.MAP.IMPORT_TOOLTIP' | translate">
            <mat-icon>download</mat-icon>
            {{ 'VENUES.MAP.IMPORT' | translate }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
