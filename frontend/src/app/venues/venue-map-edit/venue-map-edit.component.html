<div *ngIf="loading()" class="loading-container animated-pulse">
  <div class="loading-icon-wrapper">
    <mat-progress-spinner color="primary" mode="indeterminate" diameter="50"></mat-progress-spinner>
  </div>
  <p class="loading-text">Loading venue for editing...</p>
</div>

<div *ngIf="error()" class="error-container animate-fade-in">
  <mat-card appearance="outlined" class="error-card">
    <mat-card-content>
      <div class="error-icon-container">
        <mat-icon color="warn">error_outline</mat-icon>
      </div>
      <div class="error-message">
        <h3>Error Loading Venue</h3>
        <p>{{ error() }}</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<div *ngIf="venue()" class="venue-map-editor animate-fade-in">
  <!-- Header with venue info and actions -->
  <div class="editor-header">
    <div class="venue-info">
      <h1 class="venue-name">
        <mat-icon>edit</mat-icon>
        Editing: {{ venue()?.name }}
      </h1>
      <p class="venue-location">{{ venue()?.city }}, {{ venue()?.country }}</p>
    </div>
    
    <div class="header-actions">
      <button mat-stroked-button 
              color="warn" 
              (click)="cancelChanges()" 
              [disabled]="!hasChanges() || saving()">
        <mat-icon>cancel</mat-icon>
        Cancel
      </button>
      
      <button mat-raised-button 
              color="primary" 
              (click)="saveChanges()" 
              [disabled]="!hasChanges() || saving()">
        <mat-icon>save</mat-icon>
        @if (saving()) {
          <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
          Saving...
        } @else {
          Save Changes
        }
      </button>
      
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
    </div>
  </div>

  <div class="editor-content">
    <!-- Toolbar -->
    <mat-card class="toolbar-card">
      <mat-card-content class="toolbar-content">
        <!-- Edit Mode Selection -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>build</mat-icon>
            Tools
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    [class.active]="editMode() === 'select'"
                    (click)="setEditMode('select')"
                    matTooltip="Select Mode">
              <mat-icon>mouse</mat-icon>
            </button>
            <button mat-icon-button 
                    [class.active]="editMode() === 'move'"
                    (click)="setEditMode('move')"
                    matTooltip="Move Mode">
              <mat-icon>open_with</mat-icon>
            </button>
            <button mat-icon-button 
                    [class.active]="editMode() === 'rotate'"
                    (click)="setEditMode('rotate')"
                    matTooltip="Rotate Mode">
              <mat-icon>rotate_right</mat-icon>
            </button>
          </div>
        </div>

        <mat-divider vertical></mat-divider>

        <!-- Sector Actions -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>grid_view</mat-icon>
            Sectors
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="addNewSector()"
                    matTooltip="Add New Sector">
              <mat-icon>add</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="duplicateSector()"
                    [disabled]="!selectedSector()"
                    matTooltip="Duplicate Sector">
              <mat-icon>content_copy</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="deleteSector()"
                    [disabled]="!selectedSector()"
                    matTooltip="Delete Sector"
                    color="warn">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>

        <mat-divider vertical></mat-divider>

        <!-- Rotation Controls -->
        <div class="tool-group" *ngIf="selectedSector()">
          <h3 class="tool-group-title">
            <mat-icon>rotate_right</mat-icon>
            Rotate
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="rotateSector(false)"
                    matTooltip="Rotate Left">
              <mat-icon>rotate_left</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="rotateSector(true)"
                    matTooltip="Rotate Right">
              <mat-icon>rotate_right</mat-icon>
            </button>
          </div>
        </div>

        <div class="spacer"></div>

        <!-- Zoom Controls -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>zoom_in</mat-icon>
            Zoom
          </h3>
          <div class="zoom-controls">
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomOut()" 
                    matTooltip="Zoom Out">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <div class="zoom-display">{{ zoom() | number:'1.1-2' }}x</div>
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomIn()" 
                    matTooltip="Zoom In">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <button mat-stroked-button 
                    (click)="resetZoom()"
                    matTooltip="Reset Zoom">
              Reset
            </button>
          </div>
        </div>        <!-- View Options -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>visibility</mat-icon>
            View
          </h3>
          <div class="view-toggles">            <button mat-stroked-button 
                    [class.active]="showGrid()"
                    (click)="showGrid.set(!showGrid())"
                    matTooltip="Toggle Grid">
              <mat-icon>grid_on</mat-icon>
              Grid
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Canvas Area -->
    <mat-card class="canvas-card">
      <mat-card-content class="canvas-content">
        <!-- Selection Info Panel -->
        <div class="selection-panel" *ngIf="selectedSector()">
          <div class="selection-info">
            <h4>
              <mat-icon>info</mat-icon>
              Selected: {{ selectedSector()?.name }}
            </h4>
            <div class="sector-details">
              <div class="detail-item">
                <span class="detail-label">Position:</span>
                <span class="detail-value">                  X: {{ selectedSector()!.position?.x ?? 0 }}, 
                  Y: {{ selectedSector()!.position?.y ?? 0 }}
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Rotation:</span>
                <span class="detail-value">{{ selectedSector()?.rotation || 0 }}Â°</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Seats:</span>
                <span class="detail-value">{{ selectedSector()?.numberOfSeats || 0 }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Status:</span>
                <span class="detail-value status" 
                      [class.active]="selectedSector()?.status === 'active'"
                      [class.inactive]="selectedSector()?.status === 'inactive'">
                  {{ selectedSector()?.status }}
                </span>
              </div>
            </div>
          </div>          <button mat-icon-button (click)="deselectAll()" matTooltip="Deselect">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Test Button for debugging -->
        <div style="margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;" *ngIf="editableSectors().length > 0">
          <h4>Debug Test:</h4>
          <button mat-stroked-button 
                  (click)="selectSector(editableSectors()[0])"
                  color="primary">
            Test Select First Sector: {{ editableSectors()[0].name }}
          </button>
        </div>        <!-- Canvas -->
        <div class="venue-canvas-container" 
             (keydown)="$event.key === 'Escape' && deselectAll()"
             role="application"
             aria-label="Venue map editor canvas">
          <div #canvasContainer 
               class="konva-canvas" 
               [style.width.px]="canvasWidth" 
               [style.height.px]="canvasHeight">
          </div>
        </div>

        <!-- Instructions -->
        <div class="instructions-panel">
          <div class="instruction-card">
            <mat-icon>info</mat-icon>
            <div class="instruction-content">
              @switch (editMode()) {
                @case ('select') {
                  <h4>Select Mode</h4>
                  <p>Click on sectors to select them. Drag to move selected sectors.</p>
                }
                @case ('move') {
                  <h4>Move Mode</h4>
                  <p>Drag sectors to reposition them on the venue map.</p>
                }
                @case ('rotate') {
                  <h4>Rotate Mode</h4>
                  <p>Select a sector and use the rotation controls to rotate it.</p>
                }
                @default {
                  <h4>Edit Mode</h4>
                  <p>Select a tool from the toolbar to start editing.</p>
                }
              }
            </div>
          </div>

          @if (hasChanges()) {
            <div class="changes-indicator">
              <mat-icon color="warn">warning</mat-icon>
              <span>You have unsaved changes</span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
