<div *ngIf="loading()" class="loading-container animated-pulse">
  <div class="loading-icon-wrapper">
    <mat-progress-spinner color="primary" mode="indeterminate" diameter="50"></mat-progress-spinner>
  </div>
  <p class="loading-text">{{ mode === 'preview' ? 'Loading venue map...' : 'Loading venue for editing...' }}</p>
</div>

<app-error-display 
  *ngIf="error()" 
  [error]="error()!" 
  title="Error Loading Venue">
</app-error-display>

<div *ngIf="venue()" class="venue-map-editor animate-fade-in" [class.reservation-mode]="mode==='reservation'">
  <!-- Header with venue info and actions (edit & reservation modes) -->
  <div class="editor-header" *ngIf="mode === 'edit' || mode === 'reservation'">
    <div class="venue-info">
      <h1 class="venue-name">
        <mat-icon>{{ mode === 'edit' ? 'edit' : 'event_seat' }}</mat-icon>
        @if (mode === 'edit') {
          Editing: {{ venue()?.name }}
        } @else {
          Reservations: {{ eventData?.showName || venue()?.name }}
          <span *ngIf="eventData?.dateTime" class="event-date">{{ eventData?.dateTime | date:'mediumDate' }}</span>
        }
      </h1>
      <p class="venue-location">
        @if (mode === 'reservation') {
          {{ venue()?.name }}
          <span *ngIf="venue()?.address"> – {{ venue()?.address }}</span>
          <span *ngIf="venue()?.city">, {{ venue()?.city }}</span>
          <span *ngIf="venue()?.country">, {{ venue()?.country }}</span>
        } @else {
          {{ venue()?.city }}, {{ venue()?.country }}
        }
      </p>
    </div>
    <div class="header-actions">
      <button mat-stroked-button 
              color="warn" 
              (click)="cancelChanges()" 
              [disabled]="!hasChanges() || saving()">
        <mat-icon>cancel</mat-icon>
        Cancel
      </button>
      <button mat-raised-button 
              color="primary" 
              (click)="saveChanges()" 
              [disabled]="!hasChanges() || saving()">
        <mat-icon>save</mat-icon>
        @if (saving()) {
          <mat-progress-spinner diameter="20" mode="indeterminate"></mat-progress-spinner>
          Saving...
        } @else {
          Save Changes
        }
      </button>
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
    </div>
  </div>

  <div class="editor-content">
    <!-- Toolbar -->
    <mat-card class="toolbar-card">
      <mat-card-content class="toolbar-content">
        <!-- Sector Actions (only in edit mode) -->
        <div class="tool-group" *ngIf="mode === 'edit'">
          <h3 class="tool-group-title">
            <mat-icon>grid_view</mat-icon>
            Sectors
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="addNewSector()"
                    matTooltip="Add New Sector">
              <mat-icon>add</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="duplicateSector()"
                    [disabled]="selectedSectors().length === 0"
                    matTooltip="Duplicate Sector">
              <mat-icon>content_copy</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="editSectorSeats()"
                    [disabled]="selectedSectors().length !== 1"
                    matTooltip="Edit Sector Seats">
              <mat-icon>event_seat</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="openChangeSectorNameDialog()"
                    [disabled]="selectedSectors().length !== 1"
                    matTooltip="Change Name">
              <mat-icon>drive_file_rename_outline</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="deleteSector()"
                    [disabled]="selectedSectors().length === 0"
                    matTooltip="Delete Sector"
                    color="warn">
              <mat-icon>delete</mat-icon>
            </button>
            <div class="vertical-divider"></div>
          </div>
        </div>

        <!-- Rotation Controls (only in edit mode) -->
        <div class="tool-group" *ngIf="mode === 'edit' && selectedSectors().length > 0">
          <h3 class="tool-group-title">
            <mat-icon>rotate_right</mat-icon>
            Rotate
          </h3>
          <div class="tool-buttons">
            <button mat-icon-button 
                    (click)="rotateSector(false)"
                    matTooltip="Rotate Left">
              <mat-icon>rotate_left</mat-icon>
            </button>
            <button mat-icon-button 
                    (click)="rotateSector(true)"
                    matTooltip="Rotate Right">
              <mat-icon>rotate_right</mat-icon>
            </button>
          </div>
        </div>

        <div class="spacer"></div>

        <!-- Zoom Controls (always visible) -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>zoom_in</mat-icon>
            Zoom
          </h3>
          <div class="zoom-controls">
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomOut()" 
                    [disabled]="getCurrentZoom() <= minZoomValue"
                    matTooltip="Zoom Out">
              <mat-icon>zoom_out</mat-icon>
            </button>
            <div class="zoom-display">{{ (getCurrentZoom() * 100) | number:'1.0-0' }}%</div>
            <button mat-mini-fab 
                    color="primary" 
                    (click)="zoomIn()" 
                    [disabled]="getCurrentZoom() >= maxZoomValue"
                    matTooltip="Zoom In">
              <mat-icon>zoom_in</mat-icon>
            </button>
            <button mat-stroked-button 
                    (click)="resetZoom()"
                    matTooltip="Reset Zoom">
              Reset
            </button>
          </div>
        </div>
        <!-- View Options (always visible) -->
        <div class="tool-group">
          <h3 class="tool-group-title">
            <mat-icon>visibility</mat-icon>
            View
          </h3>
          <div class="view-toggles">
            <button mat-stroked-button 
                    [class.active]="showGrid()"
                    [color]="showGrid() ? 'primary' : 'basic'"
                    (click)="toggleGridDebug()"
                    matTooltip="Toggle Grid">
              <mat-icon>grid_on</mat-icon>
              Grid {{ showGrid() ? 'ON' : 'OFF' }}
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Canvas Area -->
    <!-- Map row (canvas + optional reservation sidebar) -->
    <div class="map-row" [class.with-reservation]="mode==='reservation'">
      <mat-card class="canvas-card">
        <mat-card-content class="canvas-content">
          <!-- Canvas -->
          <div class="venue-canvas-container custom-scroll-canvas" 
               role="application"
               aria-label="Venue map editor canvas">
            <div #canvasContainer 
                 class="konva-canvas">
            </div>
          </div>

        <!-- Selection Info Panel - Moved to bottom -->
        <div class="selection-panel" *ngIf="selectedSectors().length > 0 && mode === 'edit'">
          <div class="selection-info">
            @if (selectedSectors().length === 1) {
              <h4>
                <mat-icon>info</mat-icon>
                Selected: {{ selectedSectors()[0].name }}
              </h4>
              <div class="sector-details">
                <div class="detail-item">
                  <span class="detail-label">Order:</span>
                  <span class="detail-value">{{ selectedSectors()[0].orderNumber ?? '-' }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Position:</span>
                  <span class="detail-value">                  
                    X: {{ selectedSectors()[0].position?.x ?? 0 }}, 
                    Y: {{ selectedSectors()[0].position?.y ?? 0 }}
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Rotation:</span>
                  <span class="detail-value">{{ selectedSectors()[0].rotation }}°</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Seats:</span>
                  <span class="detail-value">{{ selectedSectors()[0].numberOfSeats ?? 0 }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Status:</span>
                  <span class="detail-value status" 
                        [class.active]="selectedSectors()[0].status === 'active'"
                        [class.inactive]="selectedSectors()[0].status === 'inactive'">
                    {{ selectedSectors()[0].status }}
                  </span>
                </div>
              </div>
            } @else {
              <h4>
                <mat-icon>info</mat-icon>
                Multiple Selected ({{ selectedSectors().length }})
              </h4>
              <div class="sector-details">
                <div class="detail-item">
                  <span class="detail-label">Sectors:</span>
                  <span class="detail-value">
                    {{ getSelectedSectorNames() }}
                  </span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Total Seats:</span>
                  <span class="detail-value">
                    {{ getTotalSelectedSeats() }}
                  </span>
                </div>
              </div>
            }
          </div>
          <button mat-icon-button (click)="deselectAll()" matTooltip="Deselect">
            <mat-icon>close</mat-icon>
          </button>
        </div>

        <!-- Instructions -->
        <div class="instructions-panel" *ngIf="mode === 'edit'">
          <div class="instruction-card">
            <mat-icon>info</mat-icon>
            <div class="instruction-content">
              <h4>How to Edit</h4>
              <p>Click sectors to select them. Hold <strong>Ctrl</strong> to select multiple sectors. Drag to move selected sectors together. Use rotation controls to rotate all selected sectors. Click on empty canvas to deselect all.</p>
              <p><strong>Zoom & Pan:</strong> Hold <strong>Ctrl + scroll</strong> to zoom in/out. Use <strong>scroll wheel</strong> to pan or <strong>Alt + drag</strong> to move around the canvas.</p>
            </div>
          </div>

          @if (isCtrlPressed()) {
            <div class="ctrl-indicator">
              <mat-icon color="primary">keyboard</mat-icon>
              <span>Multi-select mode active</span>
            </div>
          }

          @if (hasChanges()) {
            <div class="changes-indicator">
              <mat-icon color="warn">warning</mat-icon>
              <span>You have unsaved changes</span>
            </div>
          }
        </div>
        </mat-card-content>
      </mat-card>

      <!-- Reservation side panel (right side) -->
      @if (mode === 'reservation') {
        <mat-card class="reservation-panel-card narrow">
          <mat-card-header>
            <mat-card-title style="display:flex;align-items:center;gap:.5rem;">
              <mat-icon>group</mat-icon>
              Participants
            </mat-card-title>
          </mat-card-header>
        <mat-card-content class="reservation-panel-content">
          @if (participantsLoading()) {
            <div class="side-loading">
              <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
              <p>Loading participants...</p>
            </div>
          } @else if (participantsError()) {
            <div class="side-error">
              <mat-icon color="warn">error_outline</mat-icon>
              <p>{{ participantsError() }}</p>
            </div>
          } @else if (!participants().length) {
            <div class="side-empty">
              <mat-icon>info</mat-icon>
              <p>No participants yet.</p>
            </div>
          } @else {
            <div class="participants-list simple" role="list" aria-label="Participants">
              <div 
                class="participant-row" 
                *ngFor="let p of participants()" 
                matTooltip="{{ p.name }} ({{ p.numberOfTickets }} tickets)"
                role="listitem"
                tabindex="0"
                (click)="selectParticipant(p)"
                (keydown.enter)="selectParticipant(p)"
                (keydown.space)="selectParticipant(p); $event.preventDefault()"
                [class.selected]="isParticipantSelected(p)"
                [attr.aria-selected]="isParticipantSelected(p)"
              >
                <div class="color" [style.background]="p.seatColor || '#bbb'"></div>
                <div class="name one-line">{{ p.name }}</div>
                <mat-icon *ngIf="isParticipantSelected(p)" class="selected-indicator" fontIcon="check_circle" color="primary"></mat-icon>
              </div>
            </div>
          }
          </mat-card-content>
        </mat-card>
      }
    </div>
  </div>
</div>
